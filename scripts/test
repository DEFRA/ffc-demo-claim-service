#!/usr/bin/env sh

set -e
projectRoot="$(a="/$0"; a=${a%/*}; a=${a:-.}; a=${a#/}/; cd "$a/.." || return; pwd)"

# Set expected prefix for Docker resource names managed by this script
dockerPrefix="ffc-demo-claim"

compose() {
  (
    cd "${projectRoot}"
    docker-compose \
    -f docker-compose.yaml \
    -f docker-compose.override.yaml \
    -f docker-compose.test.yaml \
    $@
  )
}

(
  cd "${projectRoot}"

  # Guarantee clean environment
  compose down --volumes

  # Run tests
  compose run ${dockerPrefix}-service

  # Clean up
  compose down --volumes
)
